<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L7 Traffic Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        .packet-table-container { height: 400px; overflow-y: auto; background: white; border: 1px solid #ddd; }
        .packet-row { cursor: pointer; font-family: monospace; font-size: 0.9em; }
        .packet-row:hover { background-color: #e9ecef; }
        .packet-row.selected { background-color: #cfe2ff; }
        .detail-panel { height: 300px; overflow-y: auto; background: #2d2d2d; color: #00ff00; padding: 10px; font-family: monospace; border: 1px solid #333; }
        .control-bar { margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .status-badge { font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container-fluid mt-3">
    <h3><span class="badge bg-primary">L7</span> Traffic Monitor</h3>
    
    <!-- Control Bar -->
    <div class="control-bar d-flex gap-2 align-items-center">
        <input type="text" id="ipFilter" class="form-control" placeholder="Filter by IP (e.g., 192.168.1.5)" style="max-width: 300px;">
        <button class="btn btn-primary" onclick="applyFilter()">Apply Filter</button>
        <button class="btn btn-danger" onclick="clearFilter()">Clear</button>
        <div class="vr"></div>
        <button class="btn btn-warning" id="pauseBtn" onclick="toggleSniffing()">Pause</button>
        <button class="btn btn-secondary" onclick="clearTable()">Clear Table</button>
        <span class="ms-auto text-muted" id="statusMsg">Connecting...</span>
    </div>

    <!-- Packet List -->
    <div class="card mb-3">
        <div class="card-header">Captured Packets</div>
        <div class="packet-table-container">
            <table class="table table-sm table-striped table-hover mb-0" id="packetTable">
                <thead class="table-light sticky-top">
                    <tr>
                        <th scope="col">Time</th>
                        <th scope="col">Source</th>
                        <th scope="col">Destination</th>
                        <th scope="col">Protocol</th>
                        <th scope="col">Length</th>
                        <th scope="col">Info</th>
                    </tr>
                </thead>
                <tbody id="packetBody">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Packet Details -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Packet Payload (L7)</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary active" onclick="setView('text')">Plain Text</button>
                <button class="btn btn-outline-secondary" onclick="setView('hex')">Hex Dump</button>
                <button class="btn btn-outline-secondary" onclick="setView('base64')">Base64</button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="detail-panel" id="packetDetail">
                Select a packet to view details...
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let isSniffing = true;
    let selectedPacket = null;
    let currentView = 'text';

    // Socket Events
    socket.on('connect', () => {
        updateStatus('Connected to server');
    });

    socket.on('status', (data) => {
        updateStatus(data.msg);
    });

    socket.on('new_packet', (packet) => {
        if (!isSniffing) return;
        addPacketRow(packet);
    });

    // UI Functions
    function addPacketRow(packet) {
        const tbody = document.getElementById('packetBody');
        const row = document.createElement('tr');
        row.className = 'packet-row';
        row.onclick = () => selectPacket(row, packet);
        
        // Truncate info for display
        const summary = packet.summary.length > 50 ? packet.summary.substring(0, 50) + '...' : packet.summary;

        row.innerHTML = `
            <td>${packet.timestamp}</td>
            <td>${packet.src}</td>
            <td>${packet.dst}</td>
            <td><span class="badge bg-secondary">${packet.protocol}</span></td>
            <td>${packet.length}</td>
            <td>${summary}</td>
        `;

        // Prepend to show newest first? Or append? Wireshark usually appends.
        // Let's append but auto-scroll if user is at bottom. 
        // For simplicity, let's prepend to see latest at top without scrolling logic.
        tbody.insertBefore(row, tbody.firstChild);

        // Limit table size to 500 rows to prevent browser crash
        if (tbody.children.length > 500) {
            tbody.removeChild(tbody.lastChild);
        }
    }

    function selectPacket(row, packet) {
        // Highlight logic
        document.querySelectorAll('.packet-row').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        selectedPacket = packet;
        renderDetail();
    }

    function renderDetail() {
        if (!selectedPacket) return;
        const container = document.getElementById('packetDetail');
        
        if (!selectedPacket.payload) {
            container.innerText = "No Layer 7 Payload (Empty)";
            return;
        }

        let content = "";
        
        // If it was plain text on backend, payload is string.
        // If it was binary, payload is base64 string.
        
        if (currentView === 'text') {
            if (selectedPacket.is_plain_text) {
                content = selectedPacket.payload;
            } else {
                // Try to decode base64 to text, showing placeholder if binary
                try {
                    content = atob(selectedPacket.payload);
                } catch (e) {
                    content = "[Binary Data - Switch to Hex View]";
                }
            }
        } else if (currentView === 'base64') {
            if (selectedPacket.is_plain_text) {
                content = btoa(selectedPacket.payload);
            } else {
                content = selectedPacket.payload;
            }
        } else if (currentView === 'hex') {
            // Convert to hex
            let rawStr = selectedPacket.is_plain_text ? selectedPacket.payload : atob(selectedPacket.payload);
            content = stringToHex(rawStr);
        }

        container.innerText = content;
    }

    function stringToHex(str) {
        let hex = '';
        for(let i=0;i<str.length;i++) {
            hex += ''+str.charCodeAt(i).toString(16).padStart(2, '0') + ' ';
        }
        return hex.toUpperCase();
    }

    function setView(view) {
        currentView = view;
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderDetail();
    }

    function applyFilter() {
        const ip = document.getElementById('ipFilter').value;
        socket.emit('set_filter', { ip: ip });
    }

    function clearFilter() {
        document.getElementById('ipFilter').value = '';
        socket.emit('set_filter', { ip: '' });
    }

    function toggleSniffing() {
        isSniffing = !isSniffing;
        const btn = document.getElementById('pauseBtn');
        btn.innerText = isSniffing ? "Pause" : "Resume";
        btn.className = isSniffing ? "btn btn-warning" : "btn btn-success";
        socket.emit('toggle_sniffing', { state: isSniffing });
    }

    function clearTable() {
        document.getElementById('packetBody').innerHTML = '';
        selectedPacket = null;
        document.getElementById('packetDetail').innerText = 'Select a packet to view details...';
    }

    function updateStatus(msg) {
        document.getElementById('statusMsg').innerText = msg;
    }
</script>

</body>
</html>
