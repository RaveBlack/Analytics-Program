<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L7 Traffic Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        .packet-table-container { height: 400px; overflow-y: auto; background: white; border: 1px solid #ddd; }
        .packet-row { cursor: pointer; font-family: monospace; font-size: 0.9em; }
        .packet-row:hover { background-color: #e9ecef; }
        .packet-row.selected { background-color: #cfe2ff; }
        .detail-panel { height: 300px; overflow-y: auto; background: #2d2d2d; color: #00ff00; padding: 10px; font-family: monospace; border: 1px solid #333; }
        .control-bar { margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .status-badge { font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container-fluid mt-3">
    <h3><span class="badge bg-primary">L7</span> Traffic Monitor</h3>
    
    <!-- Tools Panel -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Tools (permissioned diagnostics + Wireshark CLI)</span>
            <span class="text-muted small" id="healthMsg">Checking capabilities...</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-lg-3">
                    <label class="form-label">Interface</label>
                    <select class="form-select" id="ifaceSelect"></select>
                    <div class="form-text">Used for `tshark` captures (if installed).</div>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Ping host</label>
                    <div class="input-group">
                        <input class="form-control" id="pingHost" placeholder="e.g. 8.8.8.8 or router.local">
                        <button class="btn btn-outline-primary" onclick="doPing()">Ping</button>
                    </div>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Traceroute host</label>
                    <div class="input-group">
                        <input class="form-control" id="traceHost" placeholder="e.g. 1.1.1.1">
                        <button class="btn btn-outline-primary" onclick="doTrace()">Trace</button>
                    </div>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Wireshark capture</label>
                    <div class="input-group">
                        <input class="form-control" id="captureDuration" type="number" min="5" max="300" value="30">
                        <span class="input-group-text">sec</span>
                        <button class="btn btn-outline-success" onclick="startCapture()">Start</button>
                        <button class="btn btn-outline-danger" onclick="stopCapture()">Stop</button>
                    </div>
                    <div class="form-text">Captures are duration-limited and saved to disk.</div>
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-lg-6">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label mb-1">Device list (from ARP/neighbor cache)</label>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshDevices()">Refresh</button>
                    </div>
                    <div class="border rounded p-2 bg-light" style="height: 160px; overflow:auto; font-family: monospace; font-size: 0.85em;" id="devicesBox">
                        Loading...
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label mb-1">MITM checks (passive)</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="runMitmCheck()">Run MITM Check</button>
                            <button class="btn btn-sm btn-outline-success" onclick="startArpMonitor()">Start ARP monitor</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="stopArpMonitor()">Stop</button>
                        </div>
                    </div>
                    <div class="border rounded p-2" style="height: 160px; overflow:auto; font-family: monospace; font-size: 0.85em; background:#fff3cd;" id="mitmBox">
                        Click “Run MITM Check” to see indicators (gateway MAC change, duplicate IP mappings, ARP conflicts).
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-lg-6">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label mb-1">Captures</label>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshCaptures()">Refresh</button>
                    </div>
                    <div class="border rounded p-2 bg-light" style="height: 160px; overflow:auto; font-family: monospace; font-size: 0.85em;" id="capturesBox">
                        None
                    </div>
                </div>
                <div class="col-12">
                    <label class="form-label mb-1">Command output</label>
                    <pre class="border rounded p-2" style="height: 200px; overflow:auto; background:#111; color:#eee;" id="cmdOut">Ready.</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Bar -->
    <div class="control-bar d-flex gap-2 align-items-center">
        <input type="text" id="ipFilter" class="form-control" placeholder="Filter by IP (e.g., 192.168.1.5)" style="max-width: 300px;">
        <button class="btn btn-primary" onclick="applyFilter()">Apply Filter</button>
        <button class="btn btn-danger" onclick="clearFilter()">Clear</button>
        <div class="vr"></div>
        <button class="btn btn-warning" id="pauseBtn" onclick="toggleSniffing()">Pause</button>
        <button class="btn btn-secondary" onclick="clearTable()">Clear Table</button>
        <span class="ms-auto text-muted" id="statusMsg">Connecting...</span>
    </div>

    <!-- Packet List -->
    <div class="card mb-3">
        <div class="card-header">Captured Packets</div>
        <div class="packet-table-container">
            <table class="table table-sm table-striped table-hover mb-0" id="packetTable">
                <thead class="table-light sticky-top">
                    <tr>
                        <th scope="col">Time</th>
                        <th scope="col">Source</th>
                        <th scope="col">Destination</th>
                        <th scope="col">Protocol</th>
                        <th scope="col">Length</th>
                        <th scope="col">Info</th>
                    </tr>
                </thead>
                <tbody id="packetBody">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Packet Details -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Packet Payload (L7)</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary active" onclick="setView('text')">Plain Text</button>
                <button class="btn btn-outline-secondary" onclick="setView('hex')">Hex Dump</button>
                <button class="btn btn-outline-secondary" onclick="setView('base64')">Base64</button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="detail-panel" id="packetDetail">
                Select a packet to view details...
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let isSniffing = true;
    let selectedPacket = null;
    let currentView = 'text';
    let currentCaptureId = null;

    // Socket Events
    socket.on('connect', () => {
        updateStatus('Connected to server');
    });

    socket.on('status', (data) => {
        updateStatus(data.msg);
    });

    socket.on('new_packet', (packet) => {
        if (!isSniffing) return;
        addPacketRow(packet);
    });

    // UI Functions
    function addPacketRow(packet) {
        const tbody = document.getElementById('packetBody');
        const row = document.createElement('tr');
        row.className = 'packet-row';
        row.onclick = () => selectPacket(row, packet);
        
        // Truncate info for display
        const summary = packet.summary.length > 50 ? packet.summary.substring(0, 50) + '...' : packet.summary;

        row.innerHTML = `
            <td>${packet.timestamp}</td>
            <td>${packet.src}</td>
            <td>${packet.dst}</td>
            <td><span class="badge bg-secondary">${packet.protocol}</span></td>
            <td>${packet.length}</td>
            <td>${summary}</td>
        `;

        // Prepend to show newest first? Or append? Wireshark usually appends.
        // Let's append but auto-scroll if user is at bottom. 
        // For simplicity, let's prepend to see latest at top without scrolling logic.
        tbody.insertBefore(row, tbody.firstChild);

        // Limit table size to 500 rows to prevent browser crash
        if (tbody.children.length > 500) {
            tbody.removeChild(tbody.lastChild);
        }
    }

    function selectPacket(row, packet) {
        // Highlight logic
        document.querySelectorAll('.packet-row').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        selectedPacket = packet;
        renderDetail();
    }

    function renderDetail() {
        if (!selectedPacket) return;
        const container = document.getElementById('packetDetail');
        
        if (!selectedPacket.payload) {
            container.innerText = "No Layer 7 Payload (Empty)";
            return;
        }

        let content = "";
        
        // If it was plain text on backend, payload is string.
        // If it was binary, payload is base64 string.
        
        if (currentView === 'text') {
            if (selectedPacket.is_plain_text) {
                content = selectedPacket.payload;
            } else {
                // Try to decode base64 to text, showing placeholder if binary
                try {
                    content = atob(selectedPacket.payload);
                } catch (e) {
                    content = "[Binary Data - Switch to Hex View]";
                }
            }
        } else if (currentView === 'base64') {
            if (selectedPacket.is_plain_text) {
                content = btoa(selectedPacket.payload);
            } else {
                content = selectedPacket.payload;
            }
        } else if (currentView === 'hex') {
            // Convert to hex
            let rawStr = selectedPacket.is_plain_text ? selectedPacket.payload : atob(selectedPacket.payload);
            content = stringToHex(rawStr);
        }

        container.innerText = content;
    }

    function stringToHex(str) {
        let hex = '';
        for(let i=0;i<str.length;i++) {
            hex += ''+str.charCodeAt(i).toString(16).padStart(2, '0') + ' ';
        }
        return hex.toUpperCase();
    }

    function setView(view) {
        currentView = view;
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderDetail();
    }

    function applyFilter() {
        const ip = document.getElementById('ipFilter').value;
        socket.emit('set_filter', { ip: ip });
    }

    function clearFilter() {
        document.getElementById('ipFilter').value = '';
        socket.emit('set_filter', { ip: '' });
    }

    function toggleSniffing() {
        isSniffing = !isSniffing;
        const btn = document.getElementById('pauseBtn');
        btn.innerText = isSniffing ? "Pause" : "Resume";
        btn.className = isSniffing ? "btn btn-warning" : "btn btn-success";
        socket.emit('toggle_sniffing', { state: isSniffing });
    }

    function clearTable() {
        document.getElementById('packetBody').innerHTML = '';
        selectedPacket = null;
        document.getElementById('packetDetail').innerText = 'Select a packet to view details...';
    }

    function updateStatus(msg) {
        document.getElementById('statusMsg').innerText = msg;
    }

    // Tools helpers
    function setCmdOut(text) {
        document.getElementById('cmdOut').textContent = text || '';
    }

    async function fetchJson(url, options) {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
            const msg = data && data.error ? data.error : `Request failed (${res.status})`;
            throw new Error(msg);
        }
        return data;
    }

    async function initTools() {
        try {
            const health = await fetchJson('/api/health');
            document.getElementById('healthMsg').textContent =
                `tshark: ${health.tshark_available ? 'available' : 'missing'} • ${health.platform}`;
        } catch (e) {
            document.getElementById('healthMsg').textContent = 'Health check failed';
        }

        await refreshInterfaces();
        await refreshDevices();
        await refreshCaptures();
    }

    async function refreshInterfaces() {
        const sel = document.getElementById('ifaceSelect');
        sel.innerHTML = '';
        try {
            const data = await fetchJson('/api/interfaces');
            const ifaces = data.interfaces || [];
            if (!ifaces.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '(no interfaces found)';
                sel.appendChild(opt);
                return;
            }
            for (const i of ifaces) {
                const opt = document.createElement('option');
                opt.value = i.name;
                opt.textContent = `${i.name} (${i.state || 'unknown'})`;
                sel.appendChild(opt);
            }
        } catch (e) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(failed to load)';
            sel.appendChild(opt);
        }
    }

    async function refreshDevices() {
        const box = document.getElementById('devicesBox');
        box.textContent = 'Loading...';
        try {
            const data = await fetchJson('/api/devices');
            const devs = data.devices || [];
            if (!devs.length) {
                box.textContent = '(no devices in neighbor/ARP cache yet)';
                return;
            }
            box.textContent = devs
                .map(d => `${d.ip || ''}\t${d.mac || ''}\t${d.iface || ''}\t${d.state || ''}`.trim())
                .join('\n');
        } catch (e) {
            box.textContent = `Error: ${e.message}`;
        }
    }

    async function doPing() {
        const host = document.getElementById('pingHost').value;
        setCmdOut('Running ping...');
        try {
            const data = await fetchJson('/api/ping', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, count: 4 })
            });
            setCmdOut(data.output || '');
        } catch (e) {
            setCmdOut(`Error: ${e.message}`);
        }
    }

    async function doTrace() {
        const host = document.getElementById('traceHost').value;
        setCmdOut('Running traceroute...');
        try {
            const data = await fetchJson('/api/traceroute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, max_hops: 20 })
            });
            setCmdOut(data.output || '');
        } catch (e) {
            setCmdOut(`Error: ${e.message}`);
        }
    }

    async function startCapture() {
        const iface = document.getElementById('ifaceSelect').value;
        const duration_seconds = parseInt(document.getElementById('captureDuration').value || '30', 10);
        setCmdOut('Starting tshark capture...');
        try {
            const data = await fetchJson('/api/capture/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ interface: iface, duration_seconds })
            });
            currentCaptureId = data.capture_id;
            setCmdOut(`Capture started: ${data.filename}\n(capture_id: ${currentCaptureId})`);
            await refreshCaptures();
        } catch (e) {
            setCmdOut(`Error: ${e.message}`);
        }
    }

    async function stopCapture() {
        if (!currentCaptureId) {
            setCmdOut('No active capture_id (start a capture first).');
            return;
        }
        setCmdOut('Stopping capture...');
        try {
            await fetchJson('/api/capture/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ capture_id: currentCaptureId })
            });
            setCmdOut('Stop signal sent. (File will be finalized by tshark)');
            currentCaptureId = null;
            await refreshCaptures();
        } catch (e) {
            setCmdOut(`Error: ${e.message}`);
        }
    }

    async function refreshCaptures() {
        const box = document.getElementById('capturesBox');
        box.textContent = 'Loading...';
        try {
            const data = await fetchJson('/api/capture/list');
            const caps = data.captures || [];
            if (!caps.length) {
                box.textContent = '(no captures yet)';
                return;
            }
            box.innerHTML = '';
            for (const c of caps) {
                const line = document.createElement('div');
                const a = document.createElement('a');
                a.href = `/api/capture/download/${encodeURIComponent(c.filename)}`;
                a.textContent = c.filename;
                a.className = 'me-2';
                a.target = '_blank';
                const meta = document.createElement('span');
                meta.className = 'text-muted';
                meta.textContent = `(${Math.round((c.size_bytes || 0) / 1024)} KB, ${c.modified_at || ''})`;
                line.appendChild(a);
                line.appendChild(meta);
                box.appendChild(line);
            }
        } catch (e) {
            box.textContent = `Error: ${e.message}`;
        }
    }

    function renderMitmSummary(summary) {
        const box = document.getElementById('mitmBox');
        const indicators = summary.indicators || [];
        const gw = summary.gateway_ip ? `${summary.gateway_ip} (${summary.gateway_mac || 'mac unknown'})` : '(unknown)';
        const running = summary.arp_monitor_running ? 'running' : 'stopped';

        if (!indicators.length) {
            box.textContent = `No indicators detected right now.\nGateway: ${gw}\nARP monitor: ${running}`;
            return;
        }

        const lines = [];
        lines.push(`Gateway: ${gw}`);
        lines.push(`ARP monitor: ${running}`);
        lines.push('');
        lines.push('Indicators:');
        for (const ind of indicators) {
            lines.push(`- [${(ind.severity || 'info').toUpperCase()}] ${ind.type}`);
            if (ind.type === 'gateway_mac_changed' && ind.details) {
                lines.push(`  gateway_ip=${ind.details.gateway_ip} old=${ind.details.old_mac} new=${ind.details.new_mac}`);
            } else if (ind.type === 'duplicate_ip_mapping' && Array.isArray(ind.details)) {
                for (const c of ind.details.slice(0, 8)) {
                    lines.push(`  ip=${c.ip} macs=${(c.macs || []).join(',')}`);
                }
            }
        }
        box.textContent = lines.join('\n');
    }

    async function runMitmCheck() {
        const box = document.getElementById('mitmBox');
        box.textContent = 'Checking...';
        try {
            const summary = await fetchJson('/api/mitm/summary');
            renderMitmSummary(summary);
        } catch (e) {
            box.textContent = `Error: ${e.message}`;
        }
    }

    async function startArpMonitor() {
        const box = document.getElementById('mitmBox');
        box.textContent = 'Starting ARP monitor...';
        try {
            await fetchJson('/api/mitm/monitor/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
            await runMitmCheck();
        } catch (e) {
            box.textContent = `Error: ${e.message}`;
        }
    }

    async function stopArpMonitor() {
        const box = document.getElementById('mitmBox');
        box.textContent = 'Stopping ARP monitor...';
        try {
            await fetchJson('/api/mitm/monitor/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
            await runMitmCheck();
        } catch (e) {
            box.textContent = `Error: ${e.message}`;
        }
    }

    // Init tools on load
    initTools();
</script>

</body>
</html>
