<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L7 Traffic Monitor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* Terminal / Wireshark Theme */
        body { background-color: #1e1e1e; color: #e0e0e0; font-family: 'Consolas', 'Monaco', monospace; }
        
        /* Control Bar */
        .control-bar { background-color: #2d2d2d; padding: 15px; border-bottom: 1px solid #444; }
        
        /* Packet Table */
        .table-container { height: 45vh; overflow-y: auto; border: 1px solid #444; margin: 10px; background: #252526; }
        .table { margin-bottom: 0; color: #ccc; font-size: 0.85rem; }
        .table thead th { background-color: #333; color: #fff; border-bottom: 2px solid #555; position: sticky; top: 0; }
        .table td { border-color: #444; padding: 4px 8px; }
        .table-hover tbody tr:hover { color: #fff; background-color: #3e3e42; cursor: pointer; }
        .table-hover tbody tr.selected { background-color: #007acc; color: white; }

        /* Detail Panel */
        .detail-container { height: 40vh; margin: 10px; display: flex; flex-direction: column; }
        .detail-header { padding: 5px 10px; background: #333; border: 1px solid #444; border-bottom: none; display: flex; justify-content: space-between; align-items: center; }
        .detail-content { flex: 1; background: #1e1e1e; border: 1px solid #444; overflow: auto; padding: 10px; color: #a9b7c6; white-space: pre-wrap; font-size: 0.9rem; }
        
        /* Protocol Colors */
        .badge-tcp { background-color: #4a6fa5; }
        .badge-udp { background-color: #a54a4a; }
        .badge-icmp { background-color: #4aa558; }
        .badge-other { background-color: #666; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
    </style>
</head>
<body>

    <!-- Top Control Bar -->
    <div class="control-bar d-flex gap-2 align-items-center">
        <h5 class="m-0 me-3 text-info">L7 Monitor</h5>
        
        <div class="input-group input-group-sm" style="width: 300px;">
            <span class="input-group-text bg-dark text-light border-secondary">IP Filter</span>
            <input type="text" id="ipFilter" class="form-control bg-dark text-light border-secondary" placeholder="e.g. 192.168.1.1">
            <button class="btn btn-primary" onclick="applyFilter()">Apply</button>
        </div>

        <button class="btn btn-sm btn-outline-warning" id="pauseBtn" onclick="toggleSniffing()">Pause Stream</button>
        <button class="btn btn-sm btn-outline-danger" onclick="clearTable()">Clear List</button>
        
        <div class="ms-auto small text-muted">
            Status: <span id="statusMsg" class="text-success">Connecting...</span>
        </div>
    </div>

    <!-- Packet List Table -->
    <div class="table-container">
        <table class="table table-hover table-dark w-100">
            <thead>
                <tr>
                    <th style="width: 100px;">Time</th>
                    <th style="width: 140px;">Source</th>
                    <th style="width: 140px;">Destination</th>
                    <th style="width: 80px;">Proto</th>
                    <th style="width: 80px;">Len</th>
                    <th>Info</th>
                </tr>
            </thead>
            <tbody id="packetBody">
                <!-- Packets go here -->
            </tbody>
        </table>
    </div>

    <!-- Packet Details Panel -->
    <div class="detail-container">
        <div class="detail-header">
            <span>Packet Payload</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary text-light" onclick="setView('text')">Plain Text</button>
                <button class="btn btn-outline-secondary text-light" onclick="setView('hex')">Hex Dump</button>
                <button class="btn btn-outline-secondary text-light" onclick="setView('base64')">Base64</button>
            </div>
        </div>
        <div id="packetDetail" class="detail-content">Select a packet to inspect payload...</div>
    </div>

<script>
    const socket = io();
    let isSniffing = true;
    let selectedPacket = null;
    let currentView = 'text';

    // --- Socket Events ---
    socket.on('connect', () => updateStatus('Connected', 'text-success'));
    socket.on('disconnect', () => updateStatus('Disconnected', 'text-danger'));
    
    socket.on('status', (data) => {
        console.log("Server:", data.msg);
    });

    socket.on('new_packet', (pkt) => {
        if (!isSniffing) return;
        addPacketRow(pkt);
    });

    // --- UI Logic ---
    function addPacketRow(pkt) {
        const tbody = document.getElementById('packetBody');
        const row = document.createElement('tr');
        
        // Protocol Badge Color
        let badgeClass = 'badge-other';
        if (pkt.protocol === 'TCP') badgeClass = 'badge-tcp';
        if (pkt.protocol === 'UDP') badgeClass = 'badge-udp';
        if (pkt.protocol === 'ICMP') badgeClass = 'badge-icmp';

        row.innerHTML = `
            <td>${pkt.timestamp}</td>
            <td>${pkt.src}</td>
            <td>${pkt.dst}</td>
            <td><span class="badge ${badgeClass}">${pkt.protocol}</span></td>
            <td>${pkt.length}</td>
            <td>${pkt.summary}</td>
        `;
        
        row.onclick = () => selectRow(row, pkt);
        
        // Add to top
        tbody.prepend(row);
        
        // Limit rows for performance
        if (tbody.children.length > 500) tbody.removeChild(tbody.lastChild);
    }

    function selectRow(row, pkt) {
        document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        selectedPacket = pkt;
        renderDetail();
    }

    function renderDetail() {
        const container = document.getElementById('packetDetail');
        if (!selectedPacket) {
            container.innerText = "Select a packet...";
            return;
        }

        if (!selectedPacket.payload) {
            container.innerText = "[No Payload Data]";
            return;
        }

        let content = "";
        let raw = selectedPacket.payload; // This is either plain text OR base64 string from server
        let is_plain = selectedPacket.is_plain_text;

        try {
            if (currentView === 'text') {
                // If server said it's plain text, show it. If not, try to decode base64.
                if (is_plain) {
                    content = raw;
                } else {
                    // It's binary (sent as base64). Show placeholder or garbage.
                    content = atob(raw); 
                }
            } else if (currentView === 'base64') {
                if (is_plain) content = btoa(raw); // Convert plain to base64
                else content = raw; // Already base64
            } else if (currentView === 'hex') {
                let strToHex = is_plain ? raw : atob(raw);
                content = stringToHex(strToHex);
            }
        } catch (e) {
            content = "[Error decoding payload]";
        }

        container.innerText = content;
    }

    function stringToHex(str) {
        let hex = '';
        for (let i = 0; i < str.length; i++) {
            hex += str.charCodeAt(i).toString(16).padStart(2, '0').toUpperCase() + ' ';
            if ((i + 1) % 16 === 0) hex += '\n';
        }
        return hex;
    }

    function setView(view) {
        currentView = view;
        // Update button active state
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        // Find the button that was clicked. event.target might be the button or something inside it.
        // But since we call this from onclick, event should be available. 
        // Safer way: iterate by text or index.
        const buttons = document.querySelectorAll('.btn-group button');
        if (view === 'text') buttons[0].classList.add('active');
        if (view === 'hex') buttons[1].classList.add('active');
        if (view === 'base64') buttons[2].classList.add('active');

        renderDetail();
    }

    function toggleSniffing() {
        isSniffing = !isSniffing;
        const btn = document.getElementById('pauseBtn');
        btn.innerText = isSniffing ? "Pause Stream" : "Resume Stream";
        btn.classList.toggle('btn-outline-warning');
        btn.classList.toggle('btn-outline-success');
        socket.emit('toggle_sniffing', { state: isSniffing });
    }

    function applyFilter() {
        const ip = document.getElementById('ipFilter').value;
        socket.emit('set_filter', { ip: ip });
        updateStatus(`Filter applied: ${ip}`, 'text-info');
    }

    function clearTable() {
        document.getElementById('packetBody').innerHTML = '';
        selectedPacket = null;
        renderDetail();
    }

    function updateStatus(msg, cls) {
        const el = document.getElementById('statusMsg');
        el.innerText = msg;
        el.className = cls || '';
    }
</script>

</body>
</html>
